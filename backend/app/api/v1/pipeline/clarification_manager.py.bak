from typing import List
from ..utils.config import MAX_CLARIFICATION_ROUNDS
from ..utils.openai_utils import safe_chat_completion

class ClarificationManager:
    """
    Generates clarification questions based on missing fields.
    Uses safe_chat_completion (GPT) with a rule-based fallback.
    """
    def __init__(self, use_gpt: bool = True):
        self.use_gpt = use_gpt

    def generate(self, missing_fields: List[str], round_number: int = 1) -> List[str]:
        if round_number > MAX_CLARIFICATION_ROUNDS or not missing_fields:
            return []

        # GPT-based question formulation
        if self.use_gpt:
            prompt = (
                f"Il manque ces informations pour répondre précisément : {missing_fields}. "
                "Posez 2 ou 3 questions courtes et précises en français pour obtenir ces détails."
            )
            try:
                resp = safe_chat_completion(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.7,
                    max_tokens=150
                )
                content = resp.choices[0].message.content.strip()
                questions = [q.strip("-• \n") for q in content.split("\n") if q.strip()]
                if questions:
                    return questions
            except Exception:
                pass

        # Rule-based fallback
        questions: List[str] = []
        for field in missing_fields:
            if field == "age_jours":
                questions.append("Quel est l'âge des sujets en jours ?")
            elif field == "ferme":
                questions.append("Quel est le nom de la ferme ?")
            elif field == "race":
                questions.append("Quelle est la race ou le génotype de l'animal ?")
            else:
                questions.append(f"Pouvez-vous préciser : {field} ?")
        return questions