# üîí HSTS Preload - Guide de Soumission

**Statut actuel** : ‚úÖ **Header configur√©** - Pr√™t pour soumission √† hstspreload.org

**Date** : 2025-10-19

---

## üìã R√©sum√©

HSTS Preload permet d'inscrire votre domaine dans une liste hardcod√©e des navigateurs (Chrome, Firefox, Safari, Edge) pour **forcer HTTPS de mani√®re permanente**, m√™me lors de la premi√®re visite.

### **Avantages :**
- üõ°Ô∏è **Protection d√®s la premi√®re connexion** (pas de requ√™te HTTP initiale vuln√©rable)
- üåê **Int√©gr√© nativement aux navigateurs** (Chrome, Firefox, Safari, Edge)
- üîê **Protection permanente** m√™me si l'utilisateur tape `http://` manuellement
- ‚ö° **Performances l√©g√®rement am√©lior√©es** (pas de redirection HTTP‚ÜíHTTPS)

### **Inconv√©nients :**
- ‚è≥ **Processus de retrait long** (plusieurs mois si vous changez d'avis)
- üîí **Engagement permanent** √† servir HTTPS sur tous les sous-domaines
- üìä **Mise √† jour des navigateurs lente** (6-12 semaines pour propagation compl√®te)

---

## ‚úÖ Pr√©-requis Intelia Expert

Tous les pr√©-requis sont **d√©j√† remplis** pour expert.intelia.com :

### **1. Header HSTS Correct**
```http
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
```

‚úÖ **Status** : Configur√© dans `backend/app/main.py:514` et `frontend/next.config.js:62`

### **2. Certificat HTTPS Valide**
‚úÖ **Status** : Certificat Let's Encrypt valide (v√©rifi√© en production)

### **3. Redirection HTTP ‚Üí HTTPS**
‚úÖ **Status** : Toutes les requ√™tes HTTP redirig√©es vers HTTPS (CloudFlare + Nginx)

### **4. HTTPS sur Tous les Sous-domaines**
‚úÖ **Status** : Politique `includeSubDomains` active

### **5. Minimum max-age = 1 an (31536000 secondes)**
‚úÖ **Status** : Configur√© √† 31536000 secondes (1 an)

---

## üöÄ √âtape 1 : D√©ployer le Header HSTS Preload

### **A. V√©rifier que les changements sont en production**

Apr√®s le d√©ploiement, testez avec curl :

```bash
curl -I https://expert.intelia.com
```

**R√©sultat attendu :**
```http
HTTP/2 200
strict-transport-security: max-age=31536000; includeSubDomains; preload
```

### **B. Tester avec SecurityHeaders.com**

Visitez : https://securityheaders.com/?q=https://expert.intelia.com

**R√©sultat attendu :**
- Note : **A+**
- HSTS : ‚úÖ **Inclut `preload` directive**

---

## üìù √âtape 2 : Soumettre √† hstspreload.org

### **A. Aller sur le site officiel**

**URL** : https://hstspreload.org/

### **B. Entrer le domaine**

Dans le champ "Enter a domain", tapez :
```
expert.intelia.com
```

Cliquez sur **"Check HSTS preload status and eligibility"**

### **C. V√©rification automatique**

Le site va v√©rifier :
- ‚úÖ Header HSTS pr√©sent avec `preload`
- ‚úÖ `max-age` >= 31536000
- ‚úÖ Directive `includeSubDomains` pr√©sente
- ‚úÖ HTTPS fonctionne correctement
- ‚úÖ Pas de redirection HTTP vers un autre domaine

**Si tout est vert**, vous verrez :
> ‚úÖ **expert.intelia.com is eligible for the HSTS preload list.**

### **D. Cocher les confirmations**

Vous devez accepter 3 conditions :

1. ‚òëÔ∏è **I am the site owner** of expert.intelia.com or have the authority to preload it.
2. ‚òëÔ∏è **I understand** that preloading expert.intelia.com through this form will **prevent all HTTP access to all subdomains**.
3. ‚òëÔ∏è **I understand** that if I need to **remove my site from the preload list**, the process can take **months** and require **me to continue serving an HSTS header during that time**.

### **E. Soumettre le formulaire**

Cliquez sur **"Submit"**

**Confirmation attendue :**
> ‚úÖ **expert.intelia.com is now pending inclusion in the HSTS preload list.**

---

## ‚è±Ô∏è √âtape 3 : Attendre la Propagation

### **Timeline Typique :**

| √âtape | D√©lai | Description |
|-------|-------|-------------|
| **Soumission** | Jour 0 | Domaine soumis √† hstspreload.org |
| **Validation** | 24-48h | Validation automatique des crit√®res |
| **Inclusion dans Chromium** | 1-2 semaines | Ajout√© √† la liste Chromium (source de v√©rit√©) |
| **Propagation Chrome** | 6-12 semaines | Disponible dans Chrome stable |
| **Propagation Firefox** | 6-12 semaines | Firefox importe la liste Chromium |
| **Propagation Safari** | 6-12 semaines | Safari importe la liste Chromium |
| **Propagation Edge** | 6-12 semaines | Edge importe la liste Chromium |

### **V√©rifier le Statut d'Inclusion**

Retournez sur https://hstspreload.org/ et entrez `expert.intelia.com`

**Statuts possibles :**
- üü° **Pending** : Soumis, en attente d'inclusion
- üü¢ **Preloaded** : Inclus dans la liste Chromium
- üî¥ **Removed** : Retir√© de la liste

---

## üîç √âtape 4 : V√©rifier l'Inclusion

### **A. V√©rifier dans le Code Source Chromium**

**URL** : https://chromium.googlesource.com/chromium/src/+/main/net/http/transport_security_state_static.json

Cherchez (Ctrl+F) : `expert.intelia.com`

**R√©sultat attendu :**
```json
{ "name": "expert.intelia.com", "policy": "bulk-1-year", "mode": "force-https", "include_subdomains": true }
```

### **B. Tester avec Chrome DevTools**

1. Ouvrez Chrome
2. Tapez dans la barre d'adresse : `chrome://net-internals/#hsts`
3. Section **"Query HSTS/PKP domain"** :
   - Domaine : `expert.intelia.com`
   - Cliquez sur **"Query"**

**R√©sultat attendu (apr√®s inclusion) :**
```
static_sts_domain: expert.intelia.com
static_upgrade_mode: STRICT
static_sts_include_subdomains: true
static_sts_observed: [date]
```

### **C. Tester le Comportement R√©el**

1. Ouvrez un **nouvel onglet de navigation priv√©e**
2. Tapez **exactement** : `http://expert.intelia.com` (sans le `s`)
3. Observez la barre d'adresse

**Comportement attendu (apr√®s preload) :**
- ‚úÖ Chrome charge **directement** `https://expert.intelia.com` **sans requ√™te HTTP initiale**
- ‚úÖ Pas de redirection visible (upgrade interne avant la requ√™te r√©seau)

---

## üö® Comment Retirer le Domaine (si n√©cessaire)

### **‚ö†Ô∏è Avertissement : Processus Lent**

Retirer un domaine de la preload list prend **plusieurs mois** car :
1. Il faut attendre la prochaine mise √† jour Chromium
2. Les navigateurs mettent √† jour leur liste tous les 6-12 semaines
3. Les anciennes versions de navigateurs garderont le preload actif

### **√âtapes pour Retrait :**

#### **1. Retirer la directive `preload` du header**

**Avant (avec preload) :**
```http
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
```

**Apr√®s (sans preload, mais garder HSTS) :**
```http
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

**OU** (pour d√©sactiver compl√®tement HSTS apr√®s retrait) :
```http
Strict-Transport-Security: max-age=0
```

#### **2. Soumettre une demande de retrait**

1. Aller sur https://hstspreload.org/
2. Entrer `expert.intelia.com`
3. Cliquer sur **"Remove"**
4. Confirmer la demande

#### **3. Attendre la propagation (6-12 mois)**

Le domaine sera retir√© progressivement :
- Chromium : 1-2 semaines
- Chrome/Edge/Firefox : 6-12 semaines
- Anciennes versions de navigateurs : **Jamais** (les utilisateurs doivent mettre √† jour)

---

## üìä Monitoring du HSTS Preload

### **1. Logs de Connexion HTTP (ne devraient plus exister)**

Apr√®s preload, les navigateurs **ne feront jamais de requ√™te HTTP initiale**.

**Commande pour v√©rifier (ne devrait rien retourner) :**
```bash
# Backend logs (ne devrait montrer AUCUNE requ√™te http://)
tail -f /var/log/intelia-expert/backend.log | grep "http://expert.intelia.com"
```

**R√©sultat attendu :** Aucune requ√™te HTTP (toutes en HTTPS directement)

### **2. V√©rifier les Erreurs de Certificat**

Si le certificat HTTPS expire, les utilisateurs **ne pourront PAS contourner l'avertissement** (preload = strict).

**Dashboard √† surveiller :**
- Expiration certificat Let's Encrypt : https://crt.sh/?q=expert.intelia.com
- Renouvellement automatique : V√©rifier Certbot/CloudFlare

### **3. Script de V√©rification Mensuelle**

Cr√©er un script pour v√©rifier le statut preload :

```bash
#!/bin/bash
# verify-hsts-preload.sh

DOMAIN="expert.intelia.com"

echo "üîç V√©rification HSTS Preload pour $DOMAIN"

# 1. V√©rifier le header HSTS
echo ""
echo "1Ô∏è‚É£ Header HSTS en production :"
curl -I https://$DOMAIN 2>/dev/null | grep -i strict-transport-security

# 2. V√©rifier l'inclusion dans la preload list
echo ""
echo "2Ô∏è‚É£ Statut sur hstspreload.org :"
curl -s "https://hstspreload.org/api/v2/status?domain=$DOMAIN" | python3 -m json.tool

# 3. V√©rifier le certificat SSL
echo ""
echo "3Ô∏è‚É£ Certificat SSL :"
echo | openssl s_client -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -dates

echo ""
echo "‚úÖ V√©rification termin√©e"
```

**Automatiser avec cron (mensuel) :**
```bash
# Ajouter au crontab
0 9 1 * * /path/to/verify-hsts-preload.sh | mail -s "HSTS Preload Report" admin@intelia.com
```

---

## üß™ Tests Avant Soumission

### **Test 1 : Header HSTS Correct**

```bash
curl -I https://expert.intelia.com 2>&1 | grep -i strict-transport-security
```

**R√©sultat attendu :**
```
strict-transport-security: max-age=31536000; includeSubDomains; preload
```

### **Test 2 : Redirection HTTP ‚Üí HTTPS**

```bash
curl -I http://expert.intelia.com
```

**R√©sultat attendu :**
```
HTTP/1.1 301 Moved Permanently
Location: https://expert.intelia.com/
```

### **Test 3 : Certificat SSL Valide**

```bash
echo | openssl s_client -connect expert.intelia.com:443 2>/dev/null | openssl x509 -noout -text
```

**V√©rifier :**
- Issuer: Let's Encrypt / CloudFlare
- Not After: Date future (certificat non expir√©)
- Subject Alternative Name: expert.intelia.com

### **Test 4 : Sous-domaines en HTTPS**

Si vous avez des sous-domaines (api.expert.intelia.com, etc.) :

```bash
curl -I https://api.expert.intelia.com
```

**R√©sultat attendu :** 200 OK (ou 404 si pas utilis√©, mais **PAS d'erreur SSL**)

---

## üìã Checklist de Soumission

Avant de soumettre √† hstspreload.org :

- [x] Header HSTS avec `max-age=31536000; includeSubDomains; preload` d√©ploy√©
- [x] Certificat HTTPS valide (Let's Encrypt / CloudFlare)
- [x] Redirection HTTP ‚Üí HTTPS fonctionne (301 Permanent)
- [x] HTTPS fonctionne sur tous les sous-domaines
- [x] Test√© avec SecurityHeaders.com (score A+)
- [x] Test√© avec curl (header pr√©sent)
- [x] √âquipe technique consciente de l'engagement permanent
- [ ] Soumis sur https://hstspreload.org/
- [ ] Confirmation re√ßue (pending inclusion)

---

## üéØ Impact sur Intelia Expert

### **Avant HSTS Preload :**

1. Utilisateur tape `http://expert.intelia.com`
2. Navigateur envoie **requ√™te HTTP** (vuln√©rable √† MITM)
3. Serveur r√©pond **301 ‚Üí https://expert.intelia.com**
4. Navigateur envoie requ√™te HTTPS (s√©curis√©e)

**Vuln√©rabilit√© :** Premi√®re requ√™te HTTP interceptable par un attaquant (r√©seau public, WiFi pirate).

### **Apr√®s HSTS Preload :**

1. Utilisateur tape `http://expert.intelia.com`
2. Navigateur **consulte sa liste preload interne**
3. Navigateur upgrade automatiquement vers HTTPS **avant l'envoi de la requ√™te**
4. Aucune requ√™te HTTP n'est jamais envoy√©e

**R√©sultat :** üõ°Ô∏è Protection totale d√®s la premi√®re connexion.

---

## üîó Ressources

- **Site officiel** : https://hstspreload.org/
- **Documentation MDN** : https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security
- **Chrome Preload List** : https://chromium.googlesource.com/chromium/src/+/main/net/http/transport_security_state_static.json
- **API Status Check** : https://hstspreload.org/api/v2/status?domain=expert.intelia.com
- **Removal Process** : https://hstspreload.org/removal/

---

## ‚úÖ Recommandation Finale

**Pour Intelia Expert : SOUMETTRE √Ä HSTSPRELOAD.ORG**

**Raisons :**
1. ‚úÖ Tous les pr√©-requis sont remplis
2. ‚úÖ Expert.intelia.com est **exclusivement HTTPS** (pas de plans pour HTTP)
3. ‚úÖ Protection maximale pour les utilisateurs (connexions sensibles)
4. ‚úÖ Engagement permanent r√©aliste (application SaaS professionnelle)

**Risques minimes :**
- ‚ö†Ô∏è Si certificat SSL expire ET renouvellement automatique √©choue ‚Üí Site inaccessible (mais cela devrait √™tre monitored de toute fa√ßon)
- ‚ö†Ô∏è Si besoin de retirer preload ‚Üí Processus long (6-12 mois), mais sc√©nario improbable

**Prochaines √©tapes :**
1. D√©ployer les changements HSTS en production
2. V√©rifier avec curl que le header est pr√©sent
3. Soumettre sur https://hstspreload.org/
4. Monitorer le statut mensuel avec le script fourni
5. Attendre 6-12 semaines pour propagation compl√®te

---

*Guide cr√©√© le 2025-10-19 dans le cadre de l'optimisation de s√©curit√© OWASP Top 10.*
