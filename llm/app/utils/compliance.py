# -*- coding: utf-8 -*-
"""
compliance.py - Compliance and Biosecurity Wrapper
Version: 1.0.0
Last modified: 2025-10-28

CRITICAL: This module ensures legal defensibility by adapting disclaimers
and tone based on user role (veterinarian vs producer vs management).
"""

import logging
from typing import Dict, Optional, Tuple, Any
from enum import Enum

logger = logging.getLogger(__name__)


class UserRole(Enum):
    """User role categories for compliance"""

    VETERINARY = "health_veterinary"
    NUTRITION = "feed_nutrition"
    BREEDING = "breeding_hatchery"
    PRODUCTION = "farm_operations"
    MANAGEMENT = "management_oversight"
    EQUIPMENT = "equipment_technology"
    PROCESSING = "processing"
    UNKNOWN = "unknown"


class ComplianceLevel(Enum):
    """Compliance levels for different query types"""

    MINIMAL = "minimal"  # General information
    STANDARD = "standard"  # Normal queries
    REINFORCED = "reinforced"  # Health/disease queries
    CRITICAL = "critical"  # Biosecurity/regulatory queries


class ComplianceWrapper:
    """
    Wrapper for legal compliance and biosecurity

    Adapts disclaimers and tone based on:
    1. User role (veterinarian, producer, management)
    2. Query sensitivity (general, health, biosecurity)
    3. Language

    Legal protection:
    - Veterinarians: Minimal disclaimers (they're qualified)
    - Producers: Reinforced disclaimers (recommend vet consultation)
    - Management: Strategic disclaimers (validate with experts)

    Biosecurity compliance:
    - Critical queries get biosecurity warnings
    - Regulatory queries include compliance notes
    """

    def __init__(self) -> None:
        """Initialize compliance wrapper"""
        # Biosecurity keywords that trigger reinforced disclaimers
        self.biosecurity_keywords = {
            "en": [
                "quarantine",
                "outbreak",
                "contamination",
                "disinfection",
                "biosecurity",
                "epidemic",
                "pandemic",
                "infection control",
                "isolation",
                "decontamination",
            ],
            "fr": [
                "quarantaine",
                "√©pid√©mie",
                "contamination",
                "d√©sinfection",
                "bios√©curit√©",
                "pand√©mie",
                "contr√¥le infection",
                "isolement",
                "d√©contamination",
            ],
            "es": [
                "cuarentena",
                "brote",
                "contaminaci√≥n",
                "desinfecci√≥n",
                "bioseguridad",
                "epidemia",
                "pandemia",
                "control de infecci√≥n",
                "aislamiento",
            ],
        }

        # Regulatory keywords
        self.regulatory_keywords = {
            "en": [
                "regulation",
                "compliance",
                "legal",
                "law",
                "authorized",
                "approved",
                "certification",
                "standard",
                "requirement",
                "mandate",
            ],
            "fr": [
                "r√©glementation",
                "conformit√©",
                "l√©gal",
                "loi",
                "autoris√©",
                "approuv√©",
                "certification",
                "norme",
                "exigence",
                "mandat",
            ],
            "es": [
                "regulaci√≥n",
                "cumplimiento",
                "legal",
                "ley",
                "autorizado",
                "aprobado",
                "certificaci√≥n",
                "est√°ndar",
                "requisito",
                "mandato",
            ],
        }

        logger.info("[OK] ComplianceWrapper initialized")

    def get_compliance_level(
        self, query: str, is_veterinary_query: bool, language: str = "en"
    ) -> ComplianceLevel:
        """
        Determine compliance level for query

        Args:
            query: User query
            is_veterinary_query: Whether query is health-related
            language: Query language

        Returns:
            ComplianceLevel enum
        """
        query_lower = query.lower()

        # üö´ EXCLUDE Intelia product questions (nano, compass, unity, farmhub, cognito)
        # These are technical product questions, NOT biosecurity/veterinary questions
        intelia_products = ["nano", "compass", "unity", "farmhub", "cognito"]
        if any(product in query_lower for product in intelia_products):
            logger.debug(f"üì¶ Intelia product detected in query - using MINIMAL compliance level")
            return ComplianceLevel.MINIMAL

        # CRITICAL: Biosecurity or regulatory queries
        biosec_kw = self.biosecurity_keywords.get(
            language, self.biosecurity_keywords["en"]
        )
        reg_kw = self.regulatory_keywords.get(language, self.regulatory_keywords["en"])

        if any(kw in query_lower for kw in biosec_kw + reg_kw):
            return ComplianceLevel.CRITICAL

        # REINFORCED: Veterinary/health queries
        if is_veterinary_query:
            return ComplianceLevel.REINFORCED

        # STANDARD: Normal queries
        return ComplianceLevel.STANDARD

    def get_role_based_disclaimer(
        self,
        user_category: Optional[str],
        compliance_level: ComplianceLevel,
        language: str = "en",
    ) -> str:
        """
        Get disclaimer adapted to user role and compliance level

        Args:
            user_category: User category (health_veterinary, farm_operations, etc.)
            compliance_level: Query compliance level
            language: Response language

        Returns:
            Disclaimer text (empty string if minimal)
        """
        # Determine user role
        try:
            role = UserRole(user_category) if user_category else UserRole.UNKNOWN
        except ValueError:
            role = UserRole.UNKNOWN

        # Get appropriate disclaimer template
        disclaimer_key = self._get_disclaimer_key(role, compliance_level)

        # Get localized disclaimer
        disclaimers = self._get_disclaimers(language)
        disclaimer = disclaimers.get(disclaimer_key, "")

        if disclaimer:
            logger.debug(
                f"Compliance disclaimer: role={role.value}, level={compliance_level.value}, "
                f"key={disclaimer_key}"
            )

        return disclaimer

    def _get_disclaimer_key(self, role: UserRole, level: ComplianceLevel) -> str:
        """
        Get disclaimer key based on role and compliance level

        Returns:
            Disclaimer key (e.g., "vet_standard", "producer_critical")
        """
        # VETERINARIANS: Minimal disclaimers (they're qualified)
        if role in [UserRole.VETERINARY, UserRole.NUTRITION, UserRole.BREEDING]:
            if level == ComplianceLevel.CRITICAL:
                return "vet_critical"
            elif level == ComplianceLevel.REINFORCED:
                return "vet_reinforced"
            else:
                return "vet_minimal"  # Very light or none

        # PRODUCERS: Reinforced disclaimers (recommend vet consultation)
        elif role == UserRole.PRODUCTION:
            if level == ComplianceLevel.CRITICAL:
                return "producer_critical"
            elif level == ComplianceLevel.REINFORCED:
                return "producer_reinforced"
            else:
                return "producer_standard"

        # MANAGEMENT: Strategic disclaimers (validate with experts)
        elif role in [UserRole.MANAGEMENT, UserRole.EQUIPMENT, UserRole.PROCESSING]:
            if level == ComplianceLevel.CRITICAL:
                return "management_critical"
            elif level == ComplianceLevel.REINFORCED:
                return "management_reinforced"
            else:
                return "management_standard"

        # UNKNOWN: Default to safe (producer-level)
        else:
            if level == ComplianceLevel.CRITICAL:
                return "producer_critical"
            elif level == ComplianceLevel.REINFORCED:
                return "producer_reinforced"
            else:
                return "producer_standard"

    def _get_disclaimers(self, language: str) -> Dict[str, str]:
        """
        Get all disclaimer templates for a language

        Returns:
            Dict of disclaimer_key -> disclaimer_text
        """
        disclaimers = {
            "en": {
                # VETERINARY DISCLAIMERS (minimal - they're professionals)
                "vet_minimal": "",  # No disclaimer for general queries to vets
                "vet_reinforced": "\n\n‚öïÔ∏è **Professional Note**: This information is provided for reference. Always validate with current research and clinical guidelines.",
                "vet_critical": "\n\n‚ö†Ô∏è **Biosecurity/Regulatory Alert**: Ensure compliance with local regulations and biosecurity protocols. Consult official guidelines and regulatory authorities.",
                # PRODUCER DISCLAIMERS (reinforced - need vet guidance)
                "producer_standard": "\n\nüìã **Note**: This information is for educational purposes. For specific issues on your farm, consult a veterinarian or poultry specialist.",
                "producer_reinforced": "\n\n‚öïÔ∏è **Important**: This information does not replace veterinary consultation. For health issues, disease diagnosis, or treatment decisions, always consult a licensed veterinarian.",
                "producer_critical": "\n\n‚ö†Ô∏è **CRITICAL**: Biosecurity and regulatory compliance are essential. This information is general guidance only. For disease outbreaks, biosecurity protocols, or regulatory compliance, immediately consult:\n‚Ä¢ Your veterinarian\n‚Ä¢ Local animal health authorities\n‚Ä¢ Biosecurity officials\n\nNon-compliance may result in serious economic and legal consequences.",
                # MANAGEMENT DISCLAIMERS (strategic - need expert validation)
                "management_standard": "\n\nüìä **Management Note**: This analysis is for strategic planning. Validate recommendations with your technical team (veterinarian, nutritionist, production manager) before implementation.",
                "management_reinforced": "\n\n‚öïÔ∏è **Strategic Recommendation**: Health and production decisions should be validated by qualified professionals (veterinarians, nutritionists, specialists) before implementation.",
                "management_critical": "\n\n‚ö†Ô∏è **CRITICAL DECISION**: Biosecurity, regulatory, and compliance decisions require expert validation. Consult:\n‚Ä¢ Veterinary advisors\n‚Ä¢ Biosecurity specialists\n‚Ä¢ Legal/regulatory compliance team\n\nStrategic decisions in these areas carry significant financial and legal risks.",
            },
            "fr": {
                # V√âT√âRINAIRES (minimal)
                "vet_minimal": "",
                "vet_reinforced": "\n\n‚öïÔ∏è **Note professionnelle**: Cette information est fournie √† titre de r√©f√©rence. Toujours valider avec la recherche actuelle et les directives cliniques.",
                "vet_critical": "\n\n‚ö†Ô∏è **Alerte bios√©curit√©/r√©glementation**: Assurez la conformit√© avec les r√©glementations locales et protocoles de bios√©curit√©. Consultez les directives officielles et autorit√©s r√©glementaires.",
                # PRODUCTEURS (renforc√©)
                "producer_standard": "\n\nüìã **Note**: Cette information est √† titre √©ducatif. Pour des probl√®mes sp√©cifiques sur votre ferme, consultez un v√©t√©rinaire ou sp√©cialiste avicole.",
                "producer_reinforced": "\n\n‚öïÔ∏è **Important**: Cette information ne remplace pas une consultation v√©t√©rinaire. Pour les probl√®mes de sant√©, diagnostics ou d√©cisions de traitement, consultez toujours un v√©t√©rinaire agr√©√©.",
                "producer_critical": "\n\n‚ö†Ô∏è **CRITIQUE**: La bios√©curit√© et conformit√© r√©glementaire sont essentielles. Cette information est un guide g√©n√©ral. Pour les √©pid√©mies, protocoles de bios√©curit√© ou conformit√© r√©glementaire, consultez imm√©diatement:\n‚Ä¢ Votre v√©t√©rinaire\n‚Ä¢ Autorit√©s de sant√© animale locales\n‚Ä¢ Responsables de bios√©curit√©\n\nLa non-conformit√© peut entra√Æner de graves cons√©quences √©conomiques et l√©gales.",
                # MANAGEMENT (strat√©gique)
                "management_standard": "\n\nüìä **Note de gestion**: Cette analyse est pour la planification strat√©gique. Validez les recommandations avec votre √©quipe technique (v√©t√©rinaire, nutritionniste, directeur de production) avant mise en ≈ìuvre.",
                "management_reinforced": "\n\n‚öïÔ∏è **Recommandation strat√©gique**: Les d√©cisions de sant√© et production doivent √™tre valid√©es par des professionnels qualifi√©s (v√©t√©rinaires, nutritionnistes, sp√©cialistes) avant mise en ≈ìuvre.",
                "management_critical": "\n\n‚ö†Ô∏è **D√âCISION CRITIQUE**: Les d√©cisions de bios√©curit√©, r√©glementaires et de conformit√© n√©cessitent une validation d'experts. Consultez:\n‚Ä¢ Conseillers v√©t√©rinaires\n‚Ä¢ Sp√©cialistes en bios√©curit√©\n‚Ä¢ √âquipe juridique/conformit√© r√©glementaire\n\nLes d√©cisions strat√©giques dans ces domaines comportent des risques financiers et l√©gaux importants.",
            },
            "es": {
                # VETERINARIOS (m√≠nimo)
                "vet_minimal": "",
                "vet_reinforced": "\n\n‚öïÔ∏è **Nota profesional**: Esta informaci√≥n se proporciona como referencia. Siempre valide con investigaci√≥n actual y directrices cl√≠nicas.",
                "vet_critical": "\n\n‚ö†Ô∏è **Alerta bioseguridad/regulatoria**: Asegure cumplimiento con regulaciones locales y protocolos de bioseguridad. Consulte directrices oficiales y autoridades regulatorias.",
                # PRODUCTORES (reforzado)
                "producer_standard": "\n\nüìã **Nota**: Esta informaci√≥n es para fines educativos. Para problemas espec√≠ficos en su granja, consulte a un veterinario o especialista av√≠cola.",
                "producer_reinforced": "\n\n‚öïÔ∏è **Importante**: Esta informaci√≥n no reemplaza consulta veterinaria. Para problemas de salud, diagn√≥sticos o decisiones de tratamiento, siempre consulte a un veterinario licenciado.",
                "producer_critical": "\n\n‚ö†Ô∏è **CR√çTICO**: Bioseguridad y cumplimiento regulatorio son esenciales. Esta informaci√≥n es orientaci√≥n general. Para brotes, protocolos de bioseguridad o cumplimiento regulatorio, consulte inmediatamente:\n‚Ä¢ Su veterinario\n‚Ä¢ Autoridades locales de salud animal\n‚Ä¢ Oficiales de bioseguridad\n\nEl incumplimiento puede resultar en graves consecuencias econ√≥micas y legales.",
                # GESTI√ìN (estrat√©gico)
                "management_standard": "\n\nüìä **Nota de gesti√≥n**: Este an√°lisis es para planificaci√≥n estrat√©gica. Valide recomendaciones con su equipo t√©cnico (veterinario, nutricionista, director de producci√≥n) antes de implementaci√≥n.",
                "management_reinforced": "\n\n‚öïÔ∏è **Recomendaci√≥n estrat√©gica**: Decisiones de salud y producci√≥n deben ser validadas por profesionales calificados (veterinarios, nutricionistas, especialistas) antes de implementaci√≥n.",
                "management_critical": "\n\n‚ö†Ô∏è **DECISI√ìN CR√çTICA**: Decisiones de bioseguridad, regulatorias y cumplimiento requieren validaci√≥n de expertos. Consulte:\n‚Ä¢ Asesores veterinarios\n‚Ä¢ Especialistas en bioseguridad\n‚Ä¢ Equipo legal/cumplimiento regulatorio\n\nDecisiones estrat√©gicas en estas √°reas conllevan riesgos financieros y legales significativos.",
            },
        }

        return disclaimers.get(language, disclaimers["en"])

    def wrap_response(
        self,
        response: str,
        query: str,
        user_category: Optional[str],
        is_veterinary_query: bool,
        language: str = "en",
    ) -> Tuple[str, Dict[str, Any]]:
        """
        Wrap response with compliance disclaimers

        Args:
            response: Generated response
            query: Original query
            user_category: User category (health_veterinary, farm_operations, etc.)
            is_veterinary_query: Whether query is health-related
            language: Response language

        Returns:
            Tuple of (wrapped_response, metadata)
        """
        # Determine compliance level
        compliance_level = self.get_compliance_level(
            query, is_veterinary_query, language
        )

        # Get role-based disclaimer
        disclaimer = self.get_role_based_disclaimer(
            user_category, compliance_level, language
        )

        # Add disclaimer if not empty
        if disclaimer:
            wrapped = response + disclaimer
        else:
            wrapped = response

        # Metadata for logging/monitoring
        metadata = {
            "compliance_level": compliance_level.value,
            "user_category": user_category or "unknown",
            "disclaimer_added": bool(disclaimer),
            "disclaimer_length": len(disclaimer) if disclaimer else 0,
        }

        return wrapped, metadata


# Singleton instance
_compliance_instance = None


def get_compliance_wrapper() -> ComplianceWrapper:
    """Get or create ComplianceWrapper singleton"""
    global _compliance_instance

    if _compliance_instance is None:
        _compliance_instance = ComplianceWrapper()

    return _compliance_instance
