# Plan de Refactoring: security/ood_detector.py

**Date:** 2025-10-05
**Objectif:** Refactoriser `security/ood_detector.py` (1,135 lignes) en architecture modulaire

---

## üìä Analyse du Fichier Actuel

### Structure Actuelle
```
security/ood_detector.py (1,135 lignes)
‚îú‚îÄ‚îÄ DomainRelevance (Enum - 5 valeurs)
‚îú‚îÄ‚îÄ DomainScore (Dataclass - 9 fields)
‚îî‚îÄ‚îÄ MultilingualOODDetector (God Class - 24 m√©thodes, ~1,000 lignes)
    ‚îú‚îÄ‚îÄ __init__
    ‚îú‚îÄ‚îÄ _init_translation_service_safe
    ‚îú‚îÄ‚îÄ _load_blocked_terms
    ‚îú‚îÄ‚îÄ _build_domain_vocabulary_from_service
    ‚îú‚îÄ‚îÄ calculate_ood_score_multilingual (PUBLIC)
    ‚îú‚îÄ‚îÄ calculate_ood_score (PUBLIC, legacy)
    ‚îú‚îÄ‚îÄ _calculate_ood_score_for_language
    ‚îú‚îÄ‚îÄ _calculate_ood_direct
    ‚îú‚îÄ‚îÄ _calculate_ood_with_translation
    ‚îú‚îÄ‚îÄ _calculate_ood_non_latin
    ‚îú‚îÄ‚îÄ _calculate_ood_fallback
    ‚îú‚îÄ‚îÄ _normalize_query
    ‚îú‚îÄ‚îÄ _analyze_query_context
    ‚îú‚îÄ‚îÄ _calculate_domain_relevance
    ‚îú‚îÄ‚îÄ _detect_blocked_terms
    ‚îú‚îÄ‚îÄ _detect_universal_patterns
    ‚îú‚îÄ‚îÄ _apply_context_boosters
    ‚îú‚îÄ‚îÄ _select_adaptive_threshold
    ‚îú‚îÄ‚îÄ _log_ood_decision
    ‚îú‚îÄ‚îÄ _update_ood_metrics
    ‚îú‚îÄ‚îÄ get_detector_stats (PUBLIC)
    ‚îî‚îÄ‚îÄ test_query_analysis (PUBLIC)
```

**Classes de Compatibilit√©:**
- `EnhancedOODDetector` (wrapper legacy, 14 lignes)

**Fonctions Factory:**
- `create_ood_detector()`
- `create_multilingual_ood_detector()`

### Probl√®mes Identifi√©s

1. **God Class Anti-Pattern:**
   - `MultilingualOODDetector`: 24 m√©thodes, ~1,000 lignes
   - 7+ responsabilit√©s m√©lang√©es dans une classe

2. **Responsabilit√©s M√©lang√©es:**
   - ‚úó Loading configuration (blocked terms, vocabulary)
   - ‚úó Translation service management
   - ‚úó Query normalization
   - ‚úó Context analysis
   - ‚úó Domain relevance calculation
   - ‚úó Multiple OOD strategies (direct, translation, non-latin, fallback)
   - ‚úó Logging and metrics
   - ‚úó Statistics and testing

3. **Configuration Hardcod√©e:**
   - 80+ lignes de configuration dans `__init__` et m√©thodes
   - Language adjustments hardcod√©s
   - Adaptive thresholds hardcod√©s
   - Fallback terms hardcod√©s

4. **Complexit√© √âlev√©e:**
   - M√©thodes de 100+ lignes (_calculate_ood_with_translation, _build_domain_vocabulary_from_service)
   - Logique conditionnelle imbriqu√©e
   - Strat√©gies multiples difficiles √† tester ind√©pendamment

---

## üéØ Architecture Cible

### Package Structure
```
security/ood/
‚îú‚îÄ‚îÄ __init__.py                          # Package entry with exports
‚îú‚îÄ‚îÄ models.py                            # Data models (~40 lignes)
‚îÇ   ‚îú‚îÄ‚îÄ DomainRelevance (Enum)
‚îÇ   ‚îî‚îÄ‚îÄ DomainScore (Dataclass)
‚îú‚îÄ‚îÄ config.py                            # Configuration constants (~150 lignes)
‚îÇ   ‚îú‚îÄ‚îÄ ADAPTIVE_THRESHOLDS
‚îÇ   ‚îú‚îÄ‚îÄ LANGUAGE_ADJUSTMENTS
‚îÇ   ‚îú‚îÄ‚îÄ FALLBACK_BLOCKED_TERMS
‚îÇ   ‚îú‚îÄ‚îÄ FALLBACK_UNIVERSAL_TERMS
‚îÇ   ‚îî‚îÄ‚îÄ TECHNICAL_PATTERNS
‚îú‚îÄ‚îÄ vocabulary_builder.py                # Domain vocabulary (~200 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ VocabularyBuilder
‚îÇ       ‚îú‚îÄ‚îÄ build_from_service()
‚îÇ       ‚îî‚îÄ‚îÄ build_fallback()
‚îú‚îÄ‚îÄ query_normalizer.py                  # Query normalization (~150 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ QueryNormalizer (static)
‚îÇ       ‚îú‚îÄ‚îÄ normalize_query()
‚îÇ       ‚îî‚îÄ‚îÄ normalize_non_latin()
‚îú‚îÄ‚îÄ context_analyzer.py                  # Context analysis (~200 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ ContextAnalyzer (static)
‚îÇ       ‚îú‚îÄ‚îÄ analyze_query_context()
‚îÇ       ‚îú‚îÄ‚îÄ detect_technical_indicators()
‚îÇ       ‚îî‚îÄ‚îÄ classify_query_type()
‚îú‚îÄ‚îÄ domain_calculator.py                 # Domain relevance (~200 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ DomainCalculator
‚îÇ       ‚îú‚îÄ‚îÄ calculate_domain_relevance()
‚îÇ       ‚îú‚îÄ‚îÄ detect_blocked_terms()
‚îÇ       ‚îú‚îÄ‚îÄ detect_universal_patterns()
‚îÇ       ‚îú‚îÄ‚îÄ apply_context_boosters()
‚îÇ       ‚îî‚îÄ‚îÄ select_adaptive_threshold()
‚îú‚îÄ‚îÄ translation_handler.py               # Translation management (~150 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ TranslationHandler
‚îÇ       ‚îú‚îÄ‚îÄ __init__() - safe initialization
‚îÇ       ‚îú‚îÄ‚îÄ translate_query()
‚îÇ       ‚îî‚îÄ‚îÄ is_available()
‚îú‚îÄ‚îÄ ood_strategies.py                    # OOD calculation strategies (~300 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ OODStrategy
‚îÇ       ‚îú‚îÄ‚îÄ calculate_direct()
‚îÇ       ‚îú‚îÄ‚îÄ calculate_with_translation()
‚îÇ       ‚îú‚îÄ‚îÄ calculate_non_latin()
‚îÇ       ‚îî‚îÄ‚îÄ calculate_fallback()
‚îú‚îÄ‚îÄ detector.py                          # Main orchestrator (~250 lignes)
‚îÇ   ‚îî‚îÄ‚îÄ OODDetector
‚îÇ       ‚îú‚îÄ‚îÄ __init__()
‚îÇ       ‚îú‚îÄ‚îÄ calculate_ood_score_multilingual() (PUBLIC)
‚îÇ       ‚îú‚îÄ‚îÄ calculate_ood_score() (PUBLIC, legacy)
‚îÇ       ‚îú‚îÄ‚îÄ get_detector_stats() (PUBLIC)
‚îÇ       ‚îî‚îÄ‚îÄ test_query_analysis() (PUBLIC)
‚îî‚îÄ‚îÄ legacy_wrapper.py                    # Backward compatibility (~50 lignes)
    ‚îú‚îÄ‚îÄ MultilingualOODDetector (wrapper)
    ‚îú‚îÄ‚îÄ EnhancedOODDetector (wrapper)
    ‚îú‚îÄ‚îÄ create_ood_detector()
    ‚îî‚îÄ‚îÄ create_multilingual_ood_detector()
```

### Responsabilit√©s par Module

#### 1. **models.py** (Data Models)
- `DomainRelevance` enum
- `DomainScore` dataclass (utilise `SerializableMixin`)
- Types purs, pas de logique

#### 2. **config.py** (Configuration)
- Externaliser toutes les configurations hardcod√©es
- Constants pour thresholds, adjustments, patterns
- Vocabulaire de fallback

#### 3. **vocabulary_builder.py** (Vocabulary Construction)
**Responsabilit√©:** Construire vocabulaire du domaine
```python
class VocabularyBuilder:
    @staticmethod
    def build_from_service(translation_service, supported_languages) -> Dict[DomainRelevance, Set[str]]:
        """Build vocabulary from translation service"""

    @staticmethod
    def build_fallback(domain_keywords) -> Dict[DomainRelevance, Set[str]]:
        """Build fallback vocabulary"""
```

#### 4. **query_normalizer.py** (Query Normalization)
**Responsabilit√©:** Normaliser queries selon la langue
```python
class QueryNormalizer:
    @staticmethod
    def normalize_query(query: str, language: str) -> str:
        """Normalize query for Latin scripts"""

    @staticmethod
    def normalize_non_latin(query: str, language: str) -> str:
        """Normalize query for non-Latin scripts"""
```

#### 5. **context_analyzer.py** (Context Analysis)
**Responsabilit√©:** Analyser contexte des queries
```python
class ContextAnalyzer:
    @staticmethod
    def analyze_query_context(query: str, words: List[str], intent_result) -> Dict:
        """Analyze query context"""

    @staticmethod
    def detect_technical_indicators(query: str) -> List[Dict]:
        """Detect technical indicators"""
```

#### 6. **domain_calculator.py** (Domain Relevance)
**Responsabilit√©:** Calculer pertinence domaine
```python
class DomainCalculator:
    def __init__(self, domain_vocabulary, blocked_terms):
        ...

    def calculate_domain_relevance(self, words, context, language) -> DomainScore:
        """Calculate domain relevance"""

    def detect_blocked_terms(self, query, words) -> Dict:
        """Detect blocked terms"""

    def detect_universal_patterns(self, query, language) -> float:
        """Detect universal patterns"""

    def apply_context_boosters(self, base_score, context, intent) -> float:
        """Apply context boosters"""

    def select_adaptive_threshold(self, context, domain_analysis) -> float:
        """Select adaptive threshold"""
```

#### 7. **translation_handler.py** (Translation Management)
**Responsabilit√©:** G√©rer service de traduction
```python
class TranslationHandler:
    def __init__(self):
        self.service = self._init_safe()
        self.cache = {}

    def _init_safe(self):
        """Safe initialization with fallback"""

    def translate_query(self, query, target_lang, source_lang) -> TranslationResult:
        """Translate query with caching"""

    def is_available(self) -> bool:
        """Check if translation service is available"""
```

#### 8. **ood_strategies.py** (OOD Calculation Strategies)
**Responsabilit√©:** Strat√©gies de calcul OOD
```python
class OODStrategy:
    def __init__(self, domain_calculator, translation_handler, normalizer, context_analyzer):
        ...

    def calculate_direct(self, query, intent, language) -> Tuple[bool, float, Dict]:
        """Direct OOD for fr/en"""

    def calculate_with_translation(self, query, intent, language) -> Tuple[bool, float, Dict]:
        """OOD with translation for Latin languages"""

    def calculate_non_latin(self, query, intent, language) -> Tuple[bool, float, Dict]:
        """OOD for non-Latin scripts"""

    def calculate_fallback(self, query, intent, language) -> Tuple[bool, float, Dict]:
        """Fallback OOD calculation"""
```

#### 9. **detector.py** (Main Orchestrator)
**Responsabilit√©:** Orchestrer d√©tection OOD
```python
class OODDetector:
    def __init__(self, blocked_terms_path=None):
        # Initialize all components
        self.vocabulary_builder = VocabularyBuilder()
        self.translation_handler = TranslationHandler()
        self.domain_calculator = DomainCalculator(...)
        self.strategy = OODStrategy(...)

    def calculate_ood_score_multilingual(self, query, intent, language) -> Tuple:
        """Main entry point - multilingual"""

    def calculate_ood_score(self, query, intent) -> Tuple:
        """Legacy entry point"""

    def get_detector_stats(self) -> Dict:
        """Get detector statistics"""

    def test_query_analysis(self, query, language) -> Dict:
        """Test and diagnose query"""
```

#### 10. **legacy_wrapper.py** (Backward Compatibility)
**Responsabilit√©:** Wrapper pour API existante
```python
class MultilingualOODDetector:
    """Wrapper for backward compatibility"""
    def __init__(self, blocked_terms_path=None):
        self._detector = OODDetector(blocked_terms_path)

    # Delegate all methods to _detector

class EnhancedOODDetector(MultilingualOODDetector):
    """Legacy alias"""
```

---

## üìã Plan d'Ex√©cution

### Phase 1: Cr√©ation des Mod√®les et Configuration
1. ‚úÖ Cr√©er `security/ood/models.py`
   - D√©placer `DomainRelevance`, `DomainScore`
   - Appliquer `SerializableMixin` √† `DomainScore`

2. ‚úÖ Cr√©er `security/ood/config.py`
   - Externaliser `ADAPTIVE_THRESHOLDS`
   - Externaliser `LANGUAGE_ADJUSTMENTS`
   - Externaliser `FALLBACK_BLOCKED_TERMS`
   - Externaliser `FALLBACK_UNIVERSAL_TERMS`
   - Externaliser `TECHNICAL_PATTERNS`

### Phase 2: Extraction des Utilitaires
3. ‚úÖ Cr√©er `security/ood/vocabulary_builder.py`
   - Extraire `_build_domain_vocabulary_from_service()`
   - Cr√©er m√©thode `build_fallback()`

4. ‚úÖ Cr√©er `security/ood/query_normalizer.py`
   - Extraire `_normalize_query()`
   - Logique sp√©cialis√©e pour scripts non-latins

5. ‚úÖ Cr√©er `security/ood/context_analyzer.py`
   - Extraire `_analyze_query_context()`
   - Logique de d√©tection d'indicateurs techniques

### Phase 3: Extraction de la Logique M√©tier
6. ‚úÖ Cr√©er `security/ood/domain_calculator.py`
   - Extraire `_calculate_domain_relevance()`
   - Extraire `_detect_blocked_terms()`
   - Extraire `_detect_universal_patterns()`
   - Extraire `_apply_context_boosters()`
   - Extraire `_select_adaptive_threshold()`

7. ‚úÖ Cr√©er `security/ood/translation_handler.py`
   - Extraire `_init_translation_service_safe()`
   - G√©rer cache de traduction

8. ‚úÖ Cr√©er `security/ood/ood_strategies.py`
   - Extraire `_calculate_ood_direct()`
   - Extraire `_calculate_ood_with_translation()`
   - Extraire `_calculate_ood_non_latin()`
   - Extraire `_calculate_ood_fallback()`

### Phase 4: Cr√©ation de l'Orchestrateur
9. ‚úÖ Cr√©er `security/ood/detector.py`
   - Classe `OODDetector` comme orchestrateur simple
   - Coordonner tous les modules
   - API publique: `calculate_ood_score_multilingual()`, `calculate_ood_score()`
   - Utilitaires: `get_detector_stats()`, `test_query_analysis()`

### Phase 5: Backward Compatibility
10. ‚úÖ Cr√©er `security/ood/legacy_wrapper.py`
    - Wrapper `MultilingualOODDetector` ‚Üí `OODDetector`
    - Wrapper `EnhancedOODDetector` ‚Üí `OODDetector`
    - Factory functions

11. ‚úÖ Cr√©er `security/ood/__init__.py`
    - Exporter nouvelle API
    - Exporter legacy API
    - Documentation

12. ‚úÖ Cr√©er `security/ood_detector_refactored.py`
    - Wrapper de compatibilit√© ultime
    - Import depuis `security.ood`

### Phase 6: Tests et Validation
13. ‚úÖ Tester imports
14. ‚úÖ Tester API nouvelle
15. ‚úÖ Tester API legacy
16. ‚úÖ Documentation finale

---

## üéØ Objectifs de Qualit√©

### M√©triques Cibles
- **Lignes par fichier:** < 350 lignes
- **Responsabilit√©s par classe:** 1 unique
- **Complexit√© cyclomatique:** R√©duite de ~85%
- **Backward compatibility:** 100%
- **Testabilit√©:** Chaque module testable ind√©pendamment

### Patterns Appliqu√©s
1. **Separation of Concerns:** Chaque module = 1 responsabilit√©
2. **Strategy Pattern:** Strat√©gies OOD interchangeables
3. **Static Utility Classes:** Normalizer, ContextAnalyzer
4. **Dependency Injection:** Composants inject√©s dans orchestrateur
5. **Safe Initialization:** Fallback robustes partout
6. **Backward Compatibility:** Wrappers transparents

---

## ‚úÖ B√©n√©fices Attendus

### Maintenabilit√©
- ‚úÖ Fichiers g√©rables (<350 lignes)
- ‚úÖ Responsabilit√©s claires
- ‚úÖ Code navigable facilement

### Testabilit√©
- ‚úÖ Modules isol√©s testables
- ‚úÖ Mocking simple
- ‚úÖ Coverage facile

### R√©utilisabilit√©
- ‚úÖ `VocabularyBuilder` r√©utilisable
- ‚úÖ `QueryNormalizer` r√©utilisable
- ‚úÖ `TranslationHandler` r√©utilisable

### √âvolutivit√©
- ‚úÖ Nouvelles strat√©gies OOD faciles √† ajouter
- ‚úÖ Nouvelle langue = config simple
- ‚úÖ Nouveaux patterns = config.py

---

## üîÑ Comparaison avec Refactorings Pr√©c√©dents

| Aspect | Guardrails | Generators | OOD Detector |
|--------|-----------|-----------|--------------|
| **Taille avant** | 1,521 lignes | 1,204 lignes | 1,135 lignes |
| **Fichiers apr√®s** | 10 modules | 9 modules | **10 modules** |
| **Pattern principal** | Orchestrator | Orchestrator | **Strategy + Orchestrator** |
| **R√©duction complexit√©** | ~85% | ~80% | **~85% (estim√©)** |
| **Backward compat** | 100% ‚úì | 100% ‚úì | **100% ‚úì** |

**Similarit√©s:**
- M√™me approche modulaire
- Separation of Concerns
- Configuration externalis√©e
- Backward compatibility wrappers

**Sp√©cificit√©s OOD:**
- **Strategy Pattern** pour 4 strat√©gies de calcul
- **Translation service** avec fallback robuste
- **Multilingual support** natif
- **Safe initialization** critique

---

## üìä Estimation

**Temps estim√©:** 2-3 heures
**Complexit√©:** Moyenne-√âlev√©e (multilingual + translation service)
**Risque:** Faible (pattern √©prouv√© √ó 2)

**Fichiers √† cr√©er:** 10
**Fichiers √† modifier:** 1 (pour imports dans agents)
**Tests requis:** Imports + API fonctionnelle

---

**Architecte:** Claude Code
**Date:** 2025-10-05
**Status:** ‚úÖ PLAN PR√äT
