// middleware.ts - CORRIG√â POUR ZOHO SALESIQ + URL WEBSOCKET MANQUANTE
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  
  try {
    const supabase = createMiddlewareClient({ req, res })
    const { data: { session } } = await supabase.auth.getSession()

    // Routes prot√©g√©es
    const protectedPaths = ['/chat', '/profile', '/settings', '/admin']
    const isProtectedPath = protectedPaths.some(path => 
      req.nextUrl.pathname.startsWith(path)
    )

    // Redirection UNIQUEMENT si pas authentifi√© sur route prot√©g√©e
    if (isProtectedPath && !session) {
      console.log('üö´ Acc√®s refus√© - Redirection vers login')
      const redirectUrl = new URL('/', req.url)
      redirectUrl.searchParams.set('redirect', req.nextUrl.pathname)
      redirectUrl.searchParams.set('message', 'login_required')
      return NextResponse.redirect(redirectUrl)
    }

    // Headers de s√©curit√© CORRIG√âS pour Zoho SalesIQ
    const response = NextResponse.next()
    
    const cspHeader = [
      "default-src 'self'",
      // ‚úÖ SCRIPT-SRC CORRIG√â pour autoriser Zoho SalesIQ
      "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://salesiq.zohopublic.com https://*.zoho.com https://*.zohostatic.com https://*.zohocdn.com",
      // ‚úÖ STYLE-SRC CORRIG√â pour autoriser Zoho SalesIQ
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://salesiq.zohopublic.com https://*.zoho.com https://*.zohostatic.com https://*.zohocdn.com",
      "font-src 'self' https://fonts.gstatic.com https://*.zoho.com https://*.zohostatic.com https://*.zohocdn.com",
      // ‚úÖ IMG-SRC CORRIG√â pour autoriser Zoho SalesIQ
      "img-src 'self' data: https: blob: https://salesiq.zohopublic.com https://*.zoho.com https://*.zohostatic.com https://*.zohocdn.com",
      // üî• CONNECT-SRC CORRIG√â - URL WEBSOCKET MANQUANTE AJOUT√âE
      "connect-src 'self' https://*.supabase.co https://expert-app-cngws.ondigitalocean.app https://salesiq.zohopublic.com https://*.zoho.com wss://*.zoho.com wss://vts.zohopublic.com wss://salesiq.zohopublic.com https://*.zohostatic.com",
      // ‚úÖ FRAME-SRC AJOUT√â pour autoriser les iframes Zoho
      "frame-src 'self' https://salesiq.zohopublic.com https://*.zoho.com",
      // ‚úÖ CHILD-SRC AJOUT√â pour autoriser les pop-ups Zoho
      "child-src 'self' https://salesiq.zohopublic.com https://*.zoho.com",
      // ‚úÖ WORKER-SRC AJOUT√â pour les service workers
      "worker-src 'self' blob:",
      "media-src 'self' https://*.zoho.com",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'none'",
      "upgrade-insecure-requests"
    ].join('; ')

    response.headers.set('Content-Security-Policy', cspHeader)
    response.headers.set('X-Frame-Options', 'DENY')
    response.headers.set('X-Content-Type-Options', 'nosniff')
    response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
    response.headers.set('X-XSS-Protection', '1; mode=block')
    
    return response

  } catch (error) {
    console.error('‚ùå Erreur middleware:', error)
    return NextResponse.next()
  }
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|images|icons|.*\\.png$|.*\\.jpg$|.*\\.svg$|.*\\.ico$).*)',
  ],
}