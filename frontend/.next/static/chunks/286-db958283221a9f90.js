"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[286],{9272:function(e,t,o){o.d(t,{useAuthStore:function(){return f}});var r=o(7208),n=o(1206),s=o(4174),i=o(8225);const a=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];console.debug("[SupabaseAuthStore/Singleton]",...t)};a("Store Auth Supabase NATIF charg\xe9 (singleton + React #300 fix)");let l=!0,u=!1;const c=()=>{console.log("[DEBUG-LOGOUT] Fin logout - r\xe9activation setState"),u=!1};let d=null;const g=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";if(l)if(!u||o.includes("logout"))try{d&&(d(e,t),console.log("[DEBUG-IMMEDIATE] setState appliqu\xe9 imm\xe9diatement:",o))}catch(r){console.error("[DEBUG-IMMEDIATE] Erreur setState imm\xe9diat:",o,r)}else console.log("[DEBUG-IMMEDIATE] safeSet bloqu\xe9 - logout en cours:",o);else console.log("[DEBUG-IMMEDIATE] safeSet bloqu\xe9 - store inactif:",o)};let h=null;const m=async()=>{if(!h)try{const{rememberMeUtils:e}=await o.e(953).then(o.bind(o,9953));h=e,console.log("[RememberMe] Utilitaires charg\xe9s dans auth store")}catch(e){console.warn("[RememberMe] Impossible de charger les utilitaires:",e),h={preserveOnLogout:()=>null,restoreAfterLogout:()=>{},clear:()=>{}}}return h};function p(e,t){var o,r;const n=(null===t||void 0===t?void 0:t.full_name)||(null===(o=e.user_metadata)||void 0===o?void 0:o.full_name)||(null===(r=e.email)||void 0===r?void 0:r.split("@")[0])||"Utilisateur",s=String(n).trim()||"Utilisateur",i=s.trim().split(" "),a=i[0]||"",l=i.slice(1).join(" ")||"";var u;return{id:e.id,email:e.email||"",name:s,firstName:a,lastName:l,phone:(null===t||void 0===t?void 0:t.phone)||"",country:(null===t||void 0===t?void 0:t.country)||"",linkedinProfile:(null===t||void 0===t?void 0:t.linkedinProfile)||"",companyName:(null===t||void 0===t?void 0:t.companyName)||"",companyWebsite:(null===t||void 0===t?void 0:t.companyWebsite)||"",linkedinCorporate:(null===t||void 0===t?void 0:t.linkedinCorporate)||"",user_type:(null===t||void 0===t?void 0:t.user_type)||"producer",language:(null===t||void 0===t?void 0:t.language)||"fr",created_at:(null===t||void 0===t?void 0:t.created_at)||(new Date).toISOString(),plan:(null===t||void 0===t?void 0:t.plan)||"essential",country_code:null===t||void 0===t?void 0:t.country_code,area_code:null===t||void 0===t?void 0:t.area_code,phone_number:null===t||void 0===t?void 0:t.phone_number,full_name:s,avatar_url:null===t||void 0===t?void 0:t.avatar_url,consent_given:null===(u=null===t||void 0===t?void 0:t.consent_given)||void 0===u||u,consent_date:null===t||void 0===t?void 0:t.consent_date,updated_at:null===t||void 0===t?void 0:t.updated_at,user_id:e.id,profile_id:null===t||void 0===t?void 0:t.profile_id,preferences:null===t||void 0===t?void 0:t.preferences,is_admin:(null===t||void 0===t?void 0:t.is_admin)||!1}}const f=(0,r.Ue)()((0,n.tJ)(((e,t)=>(d=e,{user:null,isLoading:!1,isAuthenticated:!1,hasHydrated:!1,lastAuthCheck:0,authErrors:[],setHasHydrated:e=>{g({hasHydrated:e},!1,"setHasHydrated")},handleAuthError:(e,t)=>{const o=((null===e||void 0===e?void 0:e.message)||"Authentication error").toString();console.error("[SupabaseAuth/Singleton]",t||"",e),g((e=>({authErrors:[...e.authErrors,o]})),!1,"handleAuthError")},clearAuthErrors:()=>{g({authErrors:[]},!1,"clearAuthErrors")},initializeSession:async()=>{if(u)return console.log("[DEBUG-LOGOUT] initializeSession ignor\xe9 - logout en cours"),!1;try{a("initializeSession via Supabase natif (singleton)");const t=(0,i.getSupabaseClient)(),{data:{session:n},error:s}=await t.auth.getSession();if(s)return a("Erreur session Supabase (singleton):",s),g({user:null,isAuthenticated:!1,lastAuthCheck:Date.now()},!1,"initializeSession-error"),!1;if(!n||!n.user)return a("Pas de session Supabase (singleton)"),g({user:null,isAuthenticated:!1,lastAuthCheck:Date.now()},!1,"initializeSession-no-session"),!1;a("Session Supabase trouv\xe9e (singleton):",n.user.email);let l={};try{const{data:r}=await t.from("users").select("*").eq("auth_user_id",n.user.id).single();if(r)l=r,a("Profil utilisateur trouv\xe9 (singleton):",r.user_type);else{var e,o;a("Pas de profil utilisateur, cr\xe9ation automatique (singleton)...");const{error:r}=await t.from("users").insert({auth_user_id:n.user.id,email:n.user.email,full_name:(null===(e=n.user.user_metadata)||void 0===e?void 0:e.full_name)||(null===(o=n.user.email)||void 0===o?void 0:o.split("@")[0]),user_type:"producer",language:"fr"});r||(l={user_type:"producer",language:"fr"},a("Profil cr\xe9\xe9 automatiquement (singleton)"))}}catch(r){a("Erreur profil, utilisation valeurs par d\xe9faut (singleton):",r),l={user_type:"producer",language:"fr"}}if(u)return console.log("[DEBUG-LOGOUT] initializeSession interrompu - logout en cours"),!1;const c=p(n.user,l);return g({user:c,isAuthenticated:!0,lastAuthCheck:Date.now()},!1,"initializeSession-success"),a("initializeSession r\xe9ussi (singleton):",c.email),!0}catch(n){return u||(t().handleAuthError(n,"initializeSession"),g({isAuthenticated:!1,user:null},!1,"initializeSession-catch")),!1}},checkAuth:async()=>{if(l)try{const t=(0,i.getSupabaseClient)(),{data:{session:o}}=await t.auth.getSession();if(!o||!o.user)return void g({user:null,isAuthenticated:!1,lastAuthCheck:Date.now()},!1,"checkAuth-no-session");let r={};try{const{data:e}=await t.from("users").select("*").eq("auth_user_id",o.user.id).single();e&&(r=e)}catch(e){a("Erreur r\xe9cup\xe9ration profil lors du checkAuth (singleton)")}if(!l)return void console.log("[DEBUG-TIMEOUT-STORE] checkAuth interrompu - store d\xe9mont\xe9");const n=p(o.user,r);g({user:n,isAuthenticated:!0,lastAuthCheck:Date.now()},!1,"checkAuth-success"),a("checkAuth r\xe9ussi (singleton)")}catch(o){l&&(t().handleAuthError(o,"checkAuth"),g({isAuthenticated:!1,user:null},!1,"checkAuth-error"))}else console.log("[DEBUG-TIMEOUT-STORE] checkAuth ignor\xe9 - store d\xe9mont\xe9")},login:async(e,o)=>{if(l){g({isLoading:!0,authErrors:[]},!1,"login-start"),a("login via Supabase natif (singleton):",e);try{const t=(0,i.getSupabaseClient)(),{data:r,error:n}=await t.auth.signInWithPassword({email:e,password:o});if(n)throw new Error(n.message);if(!r.user)throw new Error("Aucun utilisateur retourn\xe9");a("Login Supabase r\xe9ussi (singleton):",r.user.email),g({isLoading:!1},!1,"login-success"),sessionStorage.removeItem("recent-logout"),console.log("[Login] Flag recent-logout nettoy\xe9"),setTimeout((()=>{console.log("[Login] D\xe9clenchement \xe9v\xe9nement auth-state-changed"),window.dispatchEvent(new Event("auth-state-changed"))}),100)}catch(r){if(l){t().handleAuthError(r,"login"),a("Erreur login (singleton):",null===r||void 0===r?void 0:r.message);let e=(null===r||void 0===r?void 0:r.message)||"Erreur de connexion";throw e.includes("Invalid login credentials")?e="Email ou mot de passe incorrect":e.includes("Email not confirmed")&&(e="Veuillez confirmer votre email avant de vous connecter"),new Error(e)}}finally{g({isLoading:!1},!1,"login-finally")}}else console.log("[DEBUG-TIMEOUT-STORE] login ignor\xe9 - store d\xe9mont\xe9")},register:async(e,o,r)=>{if(l){g({isLoading:!0,authErrors:[]},!1,"register-start"),a("register via Supabase natif (singleton):",e);try{const u=String((null===r||void 0===r?void 0:r.name)||"").trim();if(!u||u.length<2)throw new Error("Le nom doit contenir au moins 2 caract\xe8res");const c=(0,i.getSupabaseClient)(),{data:d,error:h}=await c.auth.signUp({email:e,password:o,options:{data:{full_name:u,user_type:r.user_type||"producer",language:r.language||"fr"}}});if(h)throw new Error(h.message);if(!d.user)throw new Error("Erreur lors de la cr\xe9ation du compte");if(a("Inscription Supabase r\xe9ussie (singleton):",d.user.email),d.user.id)try{const{error:t}=await c.from("users").insert({auth_user_id:d.user.id,email:e,full_name:u,user_type:r.user_type||"producer",language:r.language||"fr"});t?a("Erreur cr\xe9ation profil (singleton):",t):a("Profil utilisateur cr\xe9\xe9 (singleton)")}catch(n){a("Erreur cr\xe9ation profil (singleton):",n)}g({isLoading:!1},!1,"register-profile-done"),d.session?l&&await t().initializeSession():s.ZP.success("Compte cr\xe9\xe9 ! V\xe9rifiez votre email pour confirmer votre inscription.")}catch(u){if(l){t().handleAuthError(u,"register"),a("Erreur register (singleton):",null===u||void 0===u?void 0:u.message);let e=(null===u||void 0===u?void 0:u.message)||"Erreur lors de la cr\xe9ation du compte";throw e.includes("already registered")?e="Cette adresse email est d\xe9j\xe0 utilis\xe9e":e.includes("Password should be at least")&&(e="Le mot de passe doit contenir au moins 6 caract\xe8res"),new Error(e)}}finally{g({isLoading:!1},!1,"register-finally")}}else console.log("[DEBUG-TIMEOUT-STORE] register ignor\xe9 - store d\xe9mont\xe9")},logout:async()=>{if(console.log("[DEBUG-LOGOUT] D\xe9but d\xe9connexion sans protections bloquantes"),l)try{const t=await m(),o=t.preserveOnLogout();console.log("[DEBUG-LOGOUT] Donn\xe9es RememberMe pr\xe9serv\xe9es:",o);const r=(0,i.getSupabaseClient)(),{error:n}=await r.auth.signOut();if(n)throw new Error(n.message);console.log("[DEBUG-LOGOUT] Nettoyage localStorage s\xe9lectif");try{const e=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);o&&"intelia-remember-me-persist"!==o&&(o.startsWith("supabase-")||o.startsWith("intelia-")&&"intelia-remember-me-persist"!==o||o.includes("auth")||o.includes("session")||"intelia-expert-auth"===o||"intelia-chat-storage"===o)&&e.push(o)}e.forEach((e=>{try{localStorage.removeItem(e),console.log("[DEBUG-LOGOUT] Supprim\xe9: ".concat(e))}catch(t){console.warn("[DEBUG-LOGOUT] Impossible de supprimer ".concat(e,":"),t)}})),console.log("[DEBUG-LOGOUT] ".concat(e.length," cl\xe9s supprim\xe9es, RememberMe pr\xe9serv\xe9"))}catch(e){console.warn("[DEBUG-LOGOUT] Erreur nettoyage localStorage:",e)}console.log("[DEBUG-LOGOUT] Nettoyage imm\xe9diat du store pour \xe9viter les boucles"),d&&(d({user:null,isAuthenticated:!1,isLoading:!1,authErrors:[],lastAuthCheck:Date.now()},!1),console.log("[DEBUG-LOGOUT] Store Zustand nettoy\xe9 imm\xe9diatement")),sessionStorage.setItem("recent-logout",Date.now().toString()),sessionStorage.removeItem("current-session"),c(),o&&setTimeout((()=>{try{t.restoreAfterLogout(o),console.log("[DEBUG-LOGOUT] RememberMe restaur\xe9 apr\xe8s nettoyage")}catch(n){console.warn("[DEBUG-LOGOUT] Erreur restauration RememberMe:",n)}}),100),a("Logout r\xe9ussi avec pr\xe9servation RememberMe (singleton)")}catch(t){throw console.error("[DEBUG-LOGOUT] Erreur durant logout:",t),d&&d({user:null,isAuthenticated:!1,isLoading:!1,authErrors:[],lastAuthCheck:Date.now()},!1),c(),new Error((null===t||void 0===t?void 0:t.message)||"Erreur lors de la d\xe9connexion")}else console.log("[DEBUG-TIMEOUT-STORE] logout ignor\xe9 - store d\xe9mont\xe9")},updateProfile:async e=>{if(l){g({isLoading:!0},!1,"updateProfile-start"),a("updateProfile via Supabase (singleton)");try{const o=t().user;if(!o)throw new Error("Utilisateur non connect\xe9");const r={};if(void 0!==e.firstName&&(r.first_name=String(e.firstName).trim()),void 0!==e.lastName&&(r.last_name=String(e.lastName).trim()),void 0!==e.firstName||void 0!==e.lastName){const t="".concat(e.firstName||o.firstName||""," ").concat(e.lastName||o.lastName||"").trim();if(t.length<2)throw new Error("Le nom doit contenir au moins 2 caract\xe8res");r.full_name=t}if(void 0!==e.user_type){const t=String(e.user_type);if(!["producer","professional","super_admin"].includes(t))throw new Error("Type d'utilisateur invalide");r.user_type=t}if(void 0!==e.language){const t=String(e.language);if(!["fr","en","es"].includes(t))throw new Error("Langue non support\xe9e");r.language=t}void 0!==e.country_code&&(r.country_code=e.country_code),void 0!==e.area_code&&(r.area_code=e.area_code),void 0!==e.phone_number&&(r.phone_number=e.phone_number),void 0!==e.country&&(r.country=e.country),void 0!==e.linkedinProfile&&(r.linkedin_profile=e.linkedinProfile),void 0!==e.companyName&&(r.company_name=e.companyName),void 0!==e.companyWebsite&&(r.company_website=e.companyWebsite),void 0!==e.linkedinCorporate&&(r.linkedin_corporate=e.linkedinCorporate);const n=(0,i.getSupabaseClient)(),{error:s}=await n.from("users").update(r).eq("auth_user_id",o.id);if(s)throw new Error(s.message);if(l){const r=t();if(Object.keys(e).some((t=>{var o;return(null===(o=r.user)||void 0===o?void 0:o[t])!==e[t]}))){console.log("[updateProfile] Changements d\xe9tect\xe9s - mise \xe0 jour du store");const t={...o,...e,email:o.email};g({user:t},!1,"updateProfile-success")}else console.log("[updateProfile] Pas de changements d\xe9tect\xe9s - setState l\xe9ger"),g({},!1,"updateProfile-no-changes")}a("updateProfile r\xe9ussi (singleton)")}catch(o){if(l)throw t().handleAuthError(o,"updateProfile"),new Error((null===o||void 0===o?void 0:o.message)||"Erreur de mise \xe0 jour du profil")}finally{g({isLoading:!1},!1,"updateProfile-finally")}}else console.log("[DEBUG-TIMEOUT-STORE] updateProfile ignor\xe9 - store d\xe9mont\xe9")},updateConsent:async e=>{if(l){a("updateConsent via Supabase (singleton)");try{const o=t().user;if(!o)return;const r=(0,i.getSupabaseClient)(),{error:n}=await r.from("users").update({rgpd_consent:e}).eq("auth_user_id",o.id);if(n)throw new Error(n.message)}catch(o){throw a("updateConsent error (singleton):",null===o||void 0===o?void 0:o.message),new Error((null===o||void 0===o?void 0:o.message)||"Erreur de mise \xe0 jour du consentement")}}else console.log("[DEBUG-TIMEOUT-STORE] updateConsent ignor\xe9 - store d\xe9mont\xe9")},deleteUserData:async()=>{if(!l)return void console.log("[DEBUG-TIMEOUT-STORE] deleteUserData ignor\xe9 - store d\xe9mont\xe9");const e=t().user;if(!e)throw new Error("Non authentifi\xe9");try{const r=(0,i.getSupabaseClient)(),{error:n}=await r.from("users").delete().eq("auth_user_id",e.id);n&&a("Erreur suppression profil (singleton):",n);try{(await m()).clear(),console.log("[DEBUG-LOGOUT] RememberMe nettoy\xe9 lors de la suppression du compte")}catch(o){console.warn("[DEBUG-LOGOUT] Erreur nettoyage RememberMe:",o)}l&&await t().logout()}catch(r){throw new Error((null===r||void 0===r?void 0:r.message)||"Erreur de suppression des donn\xe9es")}},exportUserData:async()=>{const e=t().user;if(!e)throw new Error("Non authentifi\xe9");try{const t=(0,i.getSupabaseClient)(),{data:o}=await t.from("users").select("*").eq("auth_user_id",e.id).single();return{user_profile:o,export_date:(new Date).toISOString(),message:"Donn\xe9es utilisateur export\xe9es"}}catch(o){throw new Error((null===o||void 0===o?void 0:o.message)||"Erreur d'exportation des donn\xe9es")}},getAuthToken:async()=>{if(!l)return console.log("[DEBUG-TIMEOUT-STORE] getAuthToken ignor\xe9 - store d\xe9mont\xe9"),null;try{const e=(0,i.getSupabaseClient)(),{data:{session:t}}=await e.auth.getSession();return(null===t||void 0===t?void 0:t.access_token)?(a("Token Supabase r\xe9cup\xe9r\xe9 pour API Expert"),t.access_token):(a("Pas de token Supabase disponible"),null)}catch(e){return a("Erreur r\xe9cup\xe9ration token:",e),null}}})),{name:"supabase-auth-store",storage:(0,n.FL)((()=>localStorage)),partialize:e=>({user:e.user,isAuthenticated:e.isAuthenticated,lastAuthCheck:e.lastAuthCheck,hasHydrated:e.hasHydrated}),onRehydrateStorage:()=>(e,t)=>{t&&console.error("Erreur rehydrate auth store:",t);const o=sessionStorage.getItem("recent-logout");if(o){const t=parseInt(o);if(Date.now()-t<1e3)return console.log("[AuthStore] Rehydration bloqu\xe9e - d\xe9connexion r\xe9cente"),void(e&&(e.user=null,e.isAuthenticated=!1))}e&&l&&(e.setHasHydrated(!0),a("Auth store rehydrat\xe9 (singleton)"))}}))},8225:function(e,t,o){o.d(t,{getSupabaseClient:function(){return l}});var r=o(9296),n=o(257);const s=n.env.NEXT_PUBLIC_SUPABASE_URL,i=n.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!s||!i)throw new Error("\u274c Variables Supabase manquantes: NEXT_PUBLIC_SUPABASE_URL et NEXT_PUBLIC_SUPABASE_ANON_KEY requises");let a=null;const l=()=>(a?console.log("\u267b\ufe0f [Supabase] R\xe9utilisation instance singleton existante"):(console.log("\ud83d\ude80 [Supabase] Cr\xe9ation instance singleton"),a=(0,r.eI)(s,i,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storage:window.localStorage,storageKey:"intelia-expert-auth"},global:{headers:{"X-Client-Info":"intelia-expert-app"}},realtime:{params:{eventsPerSecond:10}}}),console.log("\u2705 [Supabase] Instance singleton cr\xe9\xe9e avec succ\xe8s")),a);l()}}]);