name: Ultra Fast Build and Deploy

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.digitalocean.com/${{ secrets.DOCR_NAME }}
  KEEP_IMAGES: "6"  # combien d'images Ã  conserver par repo

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) DÃ©tection des changements
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed:  ${{ steps.changes.outputs.backend }}
      llm-changed:      ${{ steps.changes.outputs.llm }}
    steps:
      - uses: actions/checkout@v4
      - name: Paths filter
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            llm:
              - 'llm/**'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) Builds parallÃ¨les (sans nettoyage local par repo)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DOCR_ACCESS_TOKEN }}

      - name: Docker login to DOCR
        run: doctl registry login --expiry-seconds 600

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: |
            ${{ env.REGISTRY }}/intelia-frontend:latest
            ${{ env.REGISTRY }}/intelia-frontend:sha-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/intelia-frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/intelia-frontend:buildcache,mode=max
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            LLM_BACKEND_URL=${{ secrets.LLM_BACKEND_URL }}

  build-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DOCR_ACCESS_TOKEN }}

      - name: Docker login to DOCR
        run: doctl registry login --expiry-seconds 600

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: |
            ${{ env.REGISTRY }}/intelia-backend:latest
            ${{ env.REGISTRY }}/intelia-backend:sha-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/intelia-backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/intelia-backend:buildcache,mode=max
          build-args: |
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

  build-llm:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.llm-changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DOCR_ACCESS_TOKEN }}

      - name: Docker login to DOCR
        run: doctl registry login --expiry-seconds 600

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push LLM
        uses: docker/build-push-action@v6
        with:
          context: ./llm
          file: ./llm/Dockerfile
          platforms: linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: |
            ${{ env.REGISTRY }}/intelia-llm:latest
            ${{ env.REGISTRY }}/intelia-llm:sha-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/intelia-llm:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/intelia-llm:buildcache,mode=max

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) PRUNE centralisÃ© (idempotent, re-vÃ©rifie la prÃ©sence des digests)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prune-docr:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, build-backend, build-llm]
    if: always()  # on nettoie mÃªme si un build a Ã©chouÃ© ou a Ã©tÃ© ignorÃ©
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DOCR_ACCESS_TOKEN }}

      - name: Docker login to DOCR
        run: doctl registry login --expiry-seconds 600

      - name: ğŸ§¹ Prune DOCR (centralisÃ© & idempotent)
        shell: bash
        run: |
          set -euo pipefail

          prune_repo() {
            local repo="$1"
            local keep="$2"

            echo "ğŸ” Prune ${repo} (garder ${keep} images)..."

            # Si le repo n'existe pas, on sort calmement
            if ! doctl registry repository list --no-header 2>/dev/null | awk '{print $1}' | grep -qx "${repo}"; then
              echo "â„¹ï¸ Repo ${repo} inexistant â€” skip"
              return 0
            fi

            # RÃ©cupÃ¨re: Digest,UpdatedAt,Tags ; tri dÃ©croissant date ; ignore lignes vides
            mapfile -t all_lines < <(
              doctl registry repository list-manifests "${repo}" \
                --format Digest,UpdatedAt,Tags --no-header 2>/dev/null \
              | awk 'NF>=2 {print $1"\t"$2"\t"$3}' \
              | sort -rk2,2
            )

            local total="${#all_lines[@]}"
            if (( total == 0 )); then
              echo "âœ… Rien Ã  supprimer pour ${repo} (aucune image)"
              return 0
            fi

            if (( total <= keep )); then
              echo "âœ… ${repo}: ${total} images (â‰¤ ${keep}) â€” rien Ã  faire"
              return 0
            fi

            # On garde les "keep" plus rÃ©centes ; le reste est Ã  supprimer
            mapfile -t old_digests < <(
              printf "%s\n" "${all_lines[@]}" \
              | tail -n +$((keep+1)) \
              | awk '{print $1}' \
              | sed -n 's/^sha256:[0-9a-f]\{64\}$/&/p' \
              | uniq
            )

            if (( ${#old_digests[@]} == 0 )); then
              echo "âœ… ${repo}: rien Ã  supprimer aprÃ¨s filtrage"
              return 0
            fi

            local deleted=0 failed=0
            for dg in "${old_digests[@]}"; do
              # Re-vÃ©rifie l'existence juste avant suppression (Ã©vite "dÃ©jÃ  supprimÃ©")
              if doctl registry repository list-manifests "${repo}" --format Digest --no-header 2>/dev/null | grep -qx "${dg}"; then
                echo "ğŸ—‘ï¸ Suppression: ${dg}"
                # petit retry pour robustesse
                if doctl registry repository delete-manifest "${repo}" "${dg}" --force 2>/dev/null \
                   || (sleep 2 && doctl registry repository delete-manifest "${repo}" "${dg}" --force 2>/dev/null); then
                  ((deleted++))
                else
                  ((failed++))
                  echo "â„¹ï¸ Non supprimÃ© (concurrence/absent/verrou): ${dg} â€” on continue"
                fi
              else
                echo "â„¹ï¸ DÃ©jÃ  supprimÃ© (ou concurrent): ${dg}"
              fi
            done

            echo "ğŸ“ˆ ${repo} â€” supprimÃ©s: ${deleted} | non supprimÃ©s (non bloquants): ${failed}"
          }

          # Liste des dÃ©pÃ´ts Ã  nettoyer
          for r in intelia-frontend intelia-backend intelia-llm; do
            prune_repo "$r" "${KEEP_IMAGES}"
          done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4) (Optionnel) RÃ©capitulatif
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, build-backend, build-llm, prune-docr]
    if: always()
    steps:
      - name: RÃ©sumÃ© dÃ©ploiement
        run: |
          echo ""
          echo "ğŸš€ RÃ©sumÃ©:"
          echo "FRONTEND:  ${{ needs.detect-changes.outputs.frontend-changed == 'true' && (needs.build-frontend.result == 'success' && 'âœ… DÃ‰PLOYÃ‰' || 'âŒ Ã‰CHEC') || 'â¸ï¸ INCHANGÃ‰' }}"
          echo "BACKEND:   ${{ needs.detect-changes.outputs.backend-changed == 'true'  && (needs.build-backend.result  == 'success' && 'âœ… DÃ‰PLOYÃ‰' || 'âŒ Ã‰CHEC') || 'â¸ï¸ INCHANGÃ‰' }}"
          echo "LLM:       ${{ needs.detect-changes.outputs.llm-changed == 'true'      && (needs.build-llm.result      == 'success' && 'âœ… DÃ‰PLOYÃ‰' || 'âŒ Ã‰CHEC') || 'â¸ï¸ INCHANGÃ‰' }}"
          echo ""
          echo "ğŸ§¹ PRUNE:   ${{ needs.prune-docr.result == 'success' && 'âœ… OK' || 'âš ï¸ AVERTISSEMENTS (non bloquant)' }}"
